<?xml version="1.0" encoding="UTF-8"?>
<script xmlns="http://www.xstep.org" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
    <variables>
        <variable type="execution-file" name="execute"
            >file:///C:/Users/bruening.FDH-FFM/txstep/ueb/txstep.tu</variable>
        <variable type="permanent-file" name="kkapem-t" code="utf8"
            >file:///C:/Users/bruening.FDH-FFM/txstep/txt/proz_app-emend.txt</variable>
        <variable type="permanent-file" format="tustep" option="erase" name="intmedfile"
            >file:///C:/Users/bruening.FDH-FFM/txstep/txt/intmedfile.tf</variable>
        <variable type="permanent-file" name="kkapem" format="tustep" option="erase"
            >file:///C:/Users/bruening.FDH-FFM/txstep/txt/kkap_emend.tf</variable>
        <variable type="permanent-file" name="kkapem-txt" code="utf8" option="erase"
            >file:///C:/Users/bruening.FDH-FFM//github/gerritbruening/texthist-data/kafka/kka/kkap_emend.txt</variable>
        <variable type="permanent-file" name="kkap-em-line" code="utf8" option="erase"
            >file:///C:/Users/bruening.FDH-FFM//github/gerritbruening/texthist-data/kafka/kka/kkap-emend-lines.xml</variable>
    </variables>
    <transform source="kkapem-t" destination="intmedfile" mode="+">
        <!-- manually removed
            N=131 IDPAGE=KKAPAppp131 PN=131TYPE=LES NAME="Editorische Eingriffe" SOM=STOP ID=00713101 SOMHEAD="Der Proceß [Apparat]: Editorische Eingriffe" SOMLEVEL=2 COMHEAD="Der Proceß (Apparatband): Editorische Eingriffe"PN=131Editorische Eingriffe
            -->
        <insert-at-start>{{apparatus}}</insert-at-start>
        <define-text-units>
            <text-unit-start>
                <comparison-table>
                    <comparison-string>HANG=Y</comparison-string>
                    <!-- <no_lf/> is inserted somewhere, with a new record after it.
                        comparison-string makes sure that the record structure is clean. -->
                </comparison-table>
            </text-unit-start>
        </define-text-units>
        <!-- preparatory cleanup: -->
        <pass>
            <modify>
                <exchange>
                    <exchange-table>
                        <string-pair>
                            <search-string>ID={#}EE{#}</search-string>
                            <replacement-string/>
                        </string-pair>
                        <string-pair>
                            <search-string>COMHEAD="Der Proceß (Apparatband): Editorische Eingriffe: S. {#}"</search-string>
                            <replacement-string/>
                        </string-pair>
                        <string-pair>
                            <search-string>ALIGN=LEFT</search-string>
                            <replacement-string/>
                        </string-pair>
                        <string-pair>
                            <search-string>{{no_lf/}} </search-string>
                            <replacement-string/>
                        </string-pair>
                    </exchange-table>
                </exchange>
            </modify>
        </pass>
        <pass>
            <modify>
                <exchange>
                    <exchange-table>
                        <!-- add page reference: -->
                        <string-pair>
                            <search-string>N={|}{#}{|} NAME="#\[2013\]"</search-string>
                            <replacement-string>{{refPage n="{=2=}"/}}</replacement-string>
                        </string-pair>
                        <string-pair>
                            <search-string>PN={|}{#}{|}RIDPAGE=KKAPp{#}</search-string>
                            <replacement-string/>
                        </string-pair>
                        <!-- app volume page: -->
                        <string-pair>
                            <search-string>N={|}{#}{|} IDPAGE=KKAPAppp{#} PN={#}</search-string>
                            <replacement-string>{{pb ed="KKAP-App" n="{=2=}"/}}</replacement-string>
                        </string-pair>
                        <!-- add line ref: -->
                        <string-pair>
                            <search-string>HANG=Y PN={\0}{\0}{\0}{|}{00}{\0}{|} #\[2013\] {|}{00}{\0}</search-string>
                            <replacement-string>{{refLine n="{=2=}-{=4=}"/}}</replacement-string>
                        </string-pair>
                        <string-pair>
                            <search-string>HANG=Y PN={\0}{\0}{\0}{|}{00}{\0}</search-string>
                            <replacement-string>{{refLine n="{=2=}"/}}</replacement-string>
                        </string-pair>
                        <string-pair>
                            <search-string>||</search-string>
                            <replacement-string>{{pb type="wit"/}}</replacement-string>
                        </string-pair>
                        <string-pair>
                            <search-string>|</search-string>
                            <replacement-string>{{lb type="wit"/}}</replacement-string>
                        </string-pair>
                    </exchange-table>
                </exchange>
            </modify>
        </pass>
        <new-line-before>
            <search-table>
                <exception-string>{{pb type="wit"</exception-string>
                <search-string>{{pb</search-string>
                <search-string>{{refPage</search-string>
                <search-string>{{refLine</search-string>
            </search-table>
        </new-line-before>
        <remove-blanks where="both"/>
        <insert-at-end>{{/apparatus}}</insert-at-end>
    </transform>
    <transform source="intmedfile" destination="kkapem">
        <pass>
            <modify>
                <exchange>
                    <exchange-table>
                        <string-pair>
                            <search-string>\A{]}</search-string>
                            <!-- {&amp;a}{[} -->
                            <replacement-string>{{Ansatz/}}</replacement-string>
                        </string-pair>
                    </exchange-table>
                </exchange>
            </modify>
        </pass>
    </transform>
    <transform source="kkapem" destination="kkapem-txt"/>
    <transform source="kkapem" destination="kkap-em-line">
        <pass>
            <modify>
                <exchange>
                    <exchange-table>
                        <string-pair>
                            <search-string>refLine n="{#}{[}-{#}</search-string>
                            <replacement-string/>
                        </string-pair>
                    </exchange-table>
                </exchange>
            </modify>
        </pass>
        <pass>
            <modify>
                <exchange>
                    <exchange-table>
                        <string-pair>
                            <search-string>{{refLine n="{#}"{|}/}}{|}*</search-string>
                            <replacement-string>{=1=}}}{=3=}{{/refLine}}</replacement-string>
                        </string-pair>
                    </exchange-table>
                </exchange>
            </modify>
        </pass>
    </transform>
</script>
